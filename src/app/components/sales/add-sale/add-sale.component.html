<div class="grid grid-cols-1 gap-6">
  <div class="bg-slate-800 p-6 rounded-xl shadow-lg space-y-4">

    <!-- for barcode scan  -->
    <app-scan-barcode (barcodeScanned)="fetchProductByBarcode($event)"></app-scan-barcode>

  </div>

  <!-- ðŸ”¹ Product Detail Section -->
  <form #productForm="ngForm" (ngSubmit)="addToCart()" class="bg-slate-800 p-6 rounded-xl shadow-lg space-y-4">
    <h3 class="text-xl font-extrabold text-[#00ffee] mb-4 uppercase tracking-wide drop-shadow-md">
      Product Details
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Barcode -->
      <div class="flex flex-col">
        <label class="label-style">Barcode</label>
        <input type="text" [(ngModel)]="saleProduct.barCode" name="barCode" class="input-style" readonly />
      </div>

      <!-- Product Code -->
      <div class="flex flex-col">
        <label class="label-style">Product Code</label>
        <input type="text" [(ngModel)]="saleProduct.productCode" name="productCode" class="input-style" readonly />
      </div>

      <!-- Product Name -->
      <div class="flex flex-col">
        <label class="label-style">Product Name</label>
        <input type="text" [(ngModel)]="saleProduct.productName" name="productName" class="input-style" readonly />
      </div>

      <!-- Category -->
      <div class="flex flex-col">
        <label class="label-style">Category</label>
        <input type="text" [(ngModel)]="saleProduct.categoryName" name="categoryName" class="input-style" readonly />
      </div>

      <!-- Product Type -->
      <div class="flex flex-col">
        <label class="label-style">Product Type</label>
        <input type="text" [(ngModel)]="saleProduct.productType" name="productType" class="input-style" readonly />
      </div>

      <!-- Packed Date -->
      <div class="flex flex-col">
        <label class="label-style">Packed Date</label>
        <input type="date" [ngModel]="saleProduct.packedDate | date:'yyyy-MM-dd'"
          (ngModelChange)="saleProduct.packedDate = $event" name="packedDate" class="input-style" readonly />

      </div>

      <!-- Dimensions -->
      <div class="flex flex-col">
        <label class="label-style">Weight (g)</label>
        <input type="number" [(ngModel)]="saleProduct.packedWeight" name="packedWeight" class="input-style" readonly />
      </div>

      <div class="flex flex-col">
        <label class="label-style">Height (cm)</label>
        <input type="number" [(ngModel)]="saleProduct.packedHeight" name="packedHeight" class="input-style" readonly />
      </div>

      <div class="flex flex-col">
        <label class="label-style">Depth (cm)</label>
        <input type="number" [(ngModel)]="saleProduct.packedDepth" name="packedDepth" class="input-style" readonly />
      </div>

      <div class="flex flex-col">
        <label class="label-style">Width (cm)</label>
        <input type="number" [(ngModel)]="saleProduct.packedWidth" name="packedWidth" class="input-style" readonly />
      </div>

      <!-- Boolean Switches -->
      <div class="flex items-center gap-3">
        <input type="checkbox" [(ngModel)]="saleProduct.isPerishable" name="isPerishable" class="w-4 h-4" />
        <label class="text-white">Perishable</label>
      </div>

      <div class="flex items-center gap-3">
        <input type="checkbox" [(ngModel)]="saleProduct.status" name="status" class="w-4 h-4" disabled />
        <label class="text-white">Active</label>
      </div>
    </div>

    <!-- ðŸ”¹ Financial / Pricing Section -->
    <h4 class="text-lg font-bold text-[#00ffee] mt-6">Pricing</h4>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="flex flex-col">
        <label class="label-style">Purchase Price</label>
        <input type="number" [(ngModel)]="saleProduct.purchasePrice" name="purchasePrice" class="input-style"
          readonly />
      </div>

      <div class="flex flex-col">
        <label class="label-style">Selling Price</label>
        <input type="number" [(ngModel)]="saleProduct.sellingPrice" name="sellingPrice" class="input-style" readonly />
      </div>

      <div class="flex flex-col">
        <label class="label-style">Tax Rate (%)</label>
        <input type="number" [(ngModel)]="saleProduct.taxRate" name="taxRate" class="input-style" readonly />
      </div>

      <div class="flex flex-col">
        <label class="label-style">Discount</label>
        <input type="number" [(ngModel)]="saleProduct.discount" name="discount" placeholder="0.00" min="0" max="100"
          #discount="ngModel" class="input-style" />
        <span *ngIf="discount.invalid && discount.touched" class="text-red-500 text-xs">
          Discount must be between 0 and 100.
        </span>
      </div>

      <div class="flex flex-col md:col-span-2">
        <!-- Animated Red Label -->
        <label class="label-animated">
          Available Quantity
        </label>

        <!-- Read-only Input with animated glow -->
        <input type="number" [(ngModel)]="saleProduct.availableQuantity" name="availableQuantity"
          placeholder="Available Quantity" readonly class="input-animated cursor-not-allowed" />
      </div>



      <!-- Quantity (Required for sale) -->
      <div class="flex flex-col md:col-span-2">
        <label class="label-style">Quantity <label style="color: red;"> *</label></label>
        <input type="number" [(ngModel)]="saleProduct.quantity" name="quantity" placeholder="Enter Quantity" required
          min="1" #quantity="ngModel" class="input-style" />
        <span *ngIf="quantity.invalid && quantity.touched" class="text-red-500 text-xs">
          Quantity must be at least 1.
        </span>
      </div>
    </div>
    
    
  <!-- âœ… Extra Charges Section -->
<form [formGroup]="extraChargesForm" class="bg-slate-800 p-6 rounded-xl shadow-lg space-y-4">
  <h3 class="text-xl font-extrabold text-[#00ffee] uppercase tracking-wide mb-4">
    Extra Charges
  </h3>

  <!-- Add Button -->
  <div class="flex justify-end mb-4">
    <button
      type="button"
      (click)="addCharge()"
      class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg text-white font-semibold transition-all">
      + Add Extra Charge
    </button>
  </div>

  <!-- Dynamic Rows -->
  <div formArrayName="extraCharges" class="space-y-3">
    <div
      *ngFor="let charge of extraCharges.controls; let i = index"
      [formGroupName]="i"
      class="flex items-center gap-3 bg-slate-700/70 p-3 rounded-xl border border-slate-600">

      <input
        type="text"
        placeholder="Charge Name"
        formControlName="name"
        class="flex-1 bg-slate-800 p-2 rounded-lg text-white placeholder-gray-400 outline-none focus:ring-2 focus:ring-[#00ffee]" />

      <input
        type="number"
        placeholder="Amount (â‚¹)"
        formControlName="amount"
        class="w-32 bg-slate-800 p-2 rounded-lg text-white text-right outline-none focus:ring-2 focus:ring-[#00ffee]" />

      <button
        type="button"
        (click)="removeCharge(i)"
        class="text-red-400 hover:text-red-500 text-xl font-bold">
        âœ•
      </button>
    </div>
  </div>

  <!-- Total -->
  <div class="text-right mt-4 text-[#00ffee] font-semibold text-lg">
    Total Extra Charges: â‚¹{{ totalExtraCharges }}
  </div>
</form>
<!-- Save Product Button -->
    <button type="submit" [disabled]="productForm.invalid"
      class="w-full md:w-auto bg-[#00ffee] text-black px-6 py-2 rounded font-bold hover:bg-white transition disabled:opacity-50 disabled:cursor-not-allowed">
      Add To Cart
    </button>
  </form>

  <!-- Cart Section -->
  <div class="bg-slate-800 p-6 rounded-xl shadow-lg space-y-4">
    <h3 class="text-xl font-extrabold text-[#00ffee] mb-4 uppercase tracking-wide drop-shadow-md">
      Cart
    </h3>

    <div class="overflow-x-auto">
      <table class="w-full text-sm border-collapse">
        <thead>
          <tr class="bg-slate-700 text-[#00ffee] uppercase text-xs">
            <th class="px-3 py-2 text-left">Product</th>
            <th class="px-3 py-2 text-center">Qty</th>
            <th class="px-3 py-2 text-center">Price(Per/Qty)</th>
            <th class="px-3 py-2 text-center">Discount</th>
            <th class="px-3 py-2 text-center">Tax</th>
            <th class="px-3 py-2 text-center">Total</th>
            <th class="px-3 py-2 text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of cart; let i = index" class="border-b border-slate-600">
            <td class="px-3 py-2">{{ item.name }}</td>
            <td class="px-3 py-2 text-center">{{ item.qty}}</td>
            <td class="px-3 py-2 text-center">{{ item.sellingPrice | number:'1.2-2' }}</td>
            <td class="px-3 py-2 text-center">{{ item.discountAmt }}</td>
            <td class="px-3 py-2 text-center">{{ item.taxAmt }}%</td>
            <td class="px-3 py-2 text-center font-semibold">{{ item.total | number:'1.2-2' }}</td>
            <td class="px-3 py-2 text-center flex justify-center gap-2">
              <!-- Edit Button -->
              <button type="button" (click)="editCartItem(i)" class="text-yellow-400 hover:text-yellow-600">
                <i class="fas fa-edit"></i>
              </button>

              <!-- Delete Button -->
              <button type="button" (click)="removeFromCart(i)" class="text-red-400 hover:text-red-600">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

    </div>

    <!-- Summary -->
    <div class="flex flex-col md:flex-row justify-between items-center mt-4 text-lg font-bold">
      <span>Total Items: {{ cart.length }}</span>
      <span class="text-[#00ffee]">Grand Total: {{ grandTotal | number:'1.2-2' }}</span>
    </div>
  </div>

  <!-- Customer & Payment Info -->
  <div class="bg-slate-800 p-6 rounded-xl shadow-lg space-y-4">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-xl font-extrabold text-[#00ffee] uppercase tracking-wide drop-shadow-md">
        Customer & Payment
      </h3>

      <!-- ðŸ”˜ Sale to Old Customers Button -->
      <button (click)="openOldCustomerSale()"
        class="bg-[#00ffee] text-slate-900 font-bold px-4 py-2 rounded-lg shadow-md hover:bg-[#00ccbb] transition">
        Sale to Old Customers
      </button>
      <!-- Conditional render -->
      @if(showOldCustomer){
      <app-old-customer-popup *ngIf="showOldCustomer" (customerSelected)="onCustomerSelected($event)"
        (close)="showOldCustomer = false">
      </app-old-customer-popup>
      }
    </div>

    <form #saleForm="ngForm" (ngSubmit)="MakeTheSale()" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

        <!-- Customer Name -->
        <div class="flex flex-col">
          <label class="mb-2 text-sm md:text-base font-extrabold text-[#00ffee] uppercase tracking-wide drop-shadow-md">
            Customer Name <label style="color: red;"> *</label>
          </label>
          <input type="text" [(ngModel)]="customer.customerName" name="customerName" placeholder="Enter Customer Name"
            required minlength="3" #customerName="ngModel" class="input-style" />
          <span *ngIf="customerName.invalid && customerName.touched" class="text-red-500 text-xs">
            Name is required (min 3 chars).
          </span>
        </div>

        <!-- Customer Email -->
        <div class="flex flex-col">
          <label class="mb-2 text-sm md:text-base font-extrabold text-[#00ffee] uppercase tracking-wide drop-shadow-md">
            Email <label style="color: red;"> *</label>
          </label>
          <input type="email" [(ngModel)]="customer.email" name="email" placeholder="Enter Email" required email
            #email="ngModel" class="input-style" />
          <span *ngIf="email.invalid && email.touched" class="text-red-500 text-xs">
            Valid email is required.
          </span>
        </div>

        <!-- Customer Phone -->
        <div class="flex flex-col">
          <label class="mb-2 text-sm md:text-base font-extrabold text-[#00ffee] uppercase tracking-wide drop-shadow-md">
            Phone <label style="color: red;"> *</label>
          </label>
          <input type="tel" [(ngModel)]="customer.phoneNo" name="phoneNo" placeholder="Enter Phone Number" required
            pattern="^[0-9]{10}$" maxlength="10" #phoneNo="ngModel" class="input-style" />
          <span *ngIf="phoneNo.invalid && phoneNo.touched" class="text-red-500 text-xs">
            Enter a valid 10-digit phone number.
          </span>
        </div>


        <!-- Customer Address -->
        <div class="flex flex-col">
          <label class="mb-2 text-sm md:text-base font-extrabold text-[#00ffee] uppercase tracking-wide drop-shadow-md">
            Address <label style="color: red;"> *</label>
          </label>
          <textarea [(ngModel)]="customer.customerAddress" name="customerAddress" rows="2" placeholder="Enter Address"
            required #customerAddress="ngModel" class="input-style resize-none"></textarea>
          <span *ngIf="customerAddress.invalid && customerAddress.touched" class="text-red-500 text-xs">
            Address is required.
          </span>
        </div>

        <!-- Payment Row -->
        <!-- Payment Row 1 (Payment Method + Paid Amount) -->
        <div class="flex flex-row gap-6 w-full items-center">
          <!-- Payment Method -->
          <div class="flex flex-col flex-1 relative">
            <label for="paymentMode" class="label-style">PAYMENT METHOD <label style="color: red;"> *</label></label>
            <div class="flex items-center gap-2">
              <select id="paymentMode" [(ngModel)]="customer.paymentMode" name="paymentMode" required
                #paymentMode="ngModel" class="dropdown-style w-full" (change)="onPaymentModeChange($event)"
                [ngClass]="{'text-gray-400': customer.paymentMode === ''}">
                <option value="" disabled hidden>Select a payment method</option>
                <option value="1">Cash</option>
                <option value="2">Cheque</option>
              </select>

              <!-- Tooltip icon (visible only if Cheque is selected) -->
              <div *ngIf="customer.paymentMode === '2'" class="relative group">
                <button type="button" (click)="showChequePopup = true"
                  class="flex items-center justify-center text-blue-400 hover:text-blue-500 bg-slate-800/40 hover:bg-slate-800 rounded-full p-2 transition-all duration-200 border border-slate-700 shadow-md cursor-pointer"
                  aria-label="See cheque details">
                  <i class="fa fa-info-circle text-lg"></i>
                </button>

                <!-- Tooltip -->
                <span
                  class="absolute left-10 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-xs rounded-md px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap shadow-md border border-slate-600">
                  See cheque details
                </span>
              </div>

            </div>

            <span *ngIf="paymentMode.invalid && paymentMode.touched" class="text-red-500 text-xs">
              Payment method is required.
            </span>
          </div>





          <!-- Paid Amount -->
          <div class="flex flex-col flex-1">
            <label for="paidAmt" class="label-style">PAID AMOUNT <label style="color: red;"> *</label></label>
            <input type="number" id="paidAmt" [(ngModel)]="customer.paidAmt" name="paidAmt" class="input-style w-full"
              required min="0" (ngModelChange)="onPaidChange($event)" #paidamount="ngModel" />

            <!-- Validation -->
            <span *ngIf="paidamount.invalid && paidamount.touched" class="text-red-500 text-xs">
              Paid amount cannot be less than 0.
            </span>
          </div>

        </div>

        <!-- Payment Row 2 (Balance Due + Total Amount) -->
        <div class="flex flex-row gap-6 w-full">
          <!-- Balance Due -->
          <div class="flex flex-col flex-1">
            <label for="balanceDue" class="label-style">BALANCE DUE <label style="color: red;"> *</label></label>
            <input type="number" id="balanceDue" [(ngModel)]="customer.balanceDue" name="balanceDue"
              class="input-style w-full" required min="0" (ngModelChange)="onDueChange($event)" #balanceDue="ngModel" />

            <!-- Validation -->
            <span *ngIf="balanceDue.invalid && balanceDue.touched" class="text-red-500 text-xs">
              Balance due cannot be less than 0.
            </span>
          </div>


          <!-- Total Amount -->
          <div class="flex flex-col flex-1">
            <label for="totalAmt" class="label-style">TOTAL AMOUNT</label>
            <input type="number" id="totalAmt" [(ngModel)]="customer.totalAmt" name="totalAmt"
              class="input-style w-full" readonly />
          </div>
        </div>



        <!-- Additional Notes -->
        <div class="flex flex-col md:col-span-2">
          <label class="label-style">
            Notes
          </label>
          <textarea [(ngModel)]="customer.remark" name="remark" rows="3" placeholder="Additional notes"
            class="input-style resize-none"></textarea>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col md:flex-row gap-4">
        <button type="submit" [disabled]="saleForm.invalid || cart.length === 0"
          class="w-full md:w-1/2 bg-[#00ffee] text-black px-6 py-3 rounded-lg font-bold hover:bg-white transition disabled:opacity-50 disabled:cursor-not-allowed">
          Submit Sale
        </button>
        <button type="button" (click)="clearSale()"
          class="w-full md:w-1/2 bg-gray-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-600 transition">
          Clear Screen
        </button>
      </div>
    </form>


    <!-- PDF Modal -->
    <div *ngIf="showPdfPopup" class="fixed inset-0 bg-black/50 flex items-start justify-center z-50 pt-32">
      <div class="bg-slate-900 rounded-lg shadow-xl w-[90%] md:w-[80%] lg:w-[70%] h-[80%] relative flex flex-col">

        <!-- Close Button -->
        <button (click)="closePdfPopup()"
          class="absolute top-2 right-2 text-white bg-red-600 rounded-full w-8 h-8 flex items-center justify-center hover:bg-red-500">
          âœ•
        </button>

        <!-- PDF Viewer -->
        <iframe *ngIf="pdfUrl" [src]="pdfUrl" class="flex-1 w-full rounded-t-lg"></iframe>

        <!-- Footer with Actions -->
        <div class="bg-slate-800 p-3 flex justify-end gap-3 rounded-b-lg">
          <button (click)="downloadPdf()"
            class="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow">
            <i class="fas fa-file-pdf"></i> Download
          </button>

          <button (click)="printPdf()"
            class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow">
            <i class="fas fa-print"></i> Print
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cheque Payment Modal -->
<!-- Cheque Payment Modal (Dark Theme) -->
<div *ngIf="showChequePopup" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70">
  <div
    class="bg-slate-900 rounded-2xl shadow-2xl w-full max-w-lg p-6 relative border border-slate-700 max-h-[90vh] overflow-y-auto">

    <!-- Close Button -->
    <button (click)="cancelCheque()" class="absolute top-3 right-3 text-gray-400 hover:text-red-500 text-2xl font-bold">
      âœ•
    </button>

    <!-- Title -->
    <h2 class="text-2xl font-bold mb-4 text-[#00ffee] text-center uppercase tracking-wide">
      Enter Cheque Details
    </h2>

    <!-- Cheque Form -->
    <form #chequeForm="ngForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-white">

      <div class="flex flex-col">
        <label class="label-style">Cheque Number <span class="text-red-500">*</span></label>
        <input type="text" [(ngModel)]="cheque.chequeNumber" name="chequeNumber"
          class="input-style w-full bg-slate-800 border border-slate-600 text-white focus:ring-2 focus:ring-[#00ffee]"
          required #chequeNumber="ngModel">
      </div>

      <div class="flex flex-col">
        <label class="label-style">Bank Name <span class="text-red-500">*</span></label>
        <input type="text" [(ngModel)]="cheque.bankName" name="bankName"
          class="input-style w-full bg-slate-800 border border-slate-600 text-white focus:ring-2 focus:ring-[#00ffee]"
          required #bankName="ngModel">
      </div>

      <div class="flex flex-col">
        <label class="label-style">Branch Name <span class="text-red-500">*</span></label>
        <input type="text" [(ngModel)]="cheque.branchName" name="branchName"
          class="input-style w-full bg-slate-800 border border-slate-600 text-white focus:ring-2 focus:ring-[#00ffee]"
          required #branchName="ngModel">
      </div>

      <div class="flex flex-col">
        <label class="label-style">IFSC Code <span class="text-red-500">*</span></label>
        <input type="text" [(ngModel)]="cheque.ifsc_Code" name="ifsc_Code"
          class="input-style w-full bg-slate-800 border border-slate-600 text-white focus:ring-2 focus:ring-[#00ffee]"
          required #ifsc_Code="ngModel">
      </div>

      <div class="flex flex-col">
        <label class="label-style">Cheque Date <span class="text-red-500">*</span></label>
        <input type="date" [(ngModel)]="cheque.chequeDate" name="chequeDate"
          class="input-style w-full bg-slate-800 border border-slate-600 text-white focus:ring-2 focus:ring-[#00ffee]"
          required #chequeDate="ngModel">
      </div>

      <div class="flex flex-col">
        <label class="label-style">Amount <span class="text-red-500">*</span></label>
        <input type="number" [(ngModel)]="cheque.amount" name="amount"
          class="input-style w-full bg-slate-800 border border-slate-600 text-white focus:ring-2 focus:ring-[#00ffee]"
          required #amount="ngModel">
      </div>

      <div class="col-span-2 flex justify-end mt-4 gap-2">
        <button type="button" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-white"
          (click)="cancelCheque()">Cancel</button>
        <button type="button" class="px-4 py-2 bg-[#00ffee] hover:bg-[#00ddcc] rounded text-slate-900 font-semibold"
          [disabled]="!chequeForm.form.valid" (click)="saveCheque()">Save</button>
      </div>

    </form>
  </div>
</div>